CREATE TABLE SOCIO (
COD_TESSERA CHAR (10) PRIMARY KEY,
USERNAME VARCHAR (100) NOT NULL UNIQUE
) ;

CREATE TABLE CLIENTE (
USERNAME VARCHAR(100) PRIMARY KEY,
PASSWORD VARCHAR(25) NOT NULL,
CITTA VARCHAR(50),
VIA VARCHAR(100),
CIVICO SMALLINT,
CF CHAR(16) NOT NULL UNIQUE,
EMAIL VARCHAR(40) UNIQUE,
NOME VARCHAR(100),
COGNOME VARCHAR(100)
);


CREATE TABLE ORDINE (
USERNAME VARCHAR(100),
DATA DATE,
ORA TIME(0),
CITTA_DEST VARCHAR(100),
VIA VARCHAR(100) NOT NULL,
CIVICO SMALLINT NOT NULL,
PRIMARY KEY(USERNAME, DATA, ORA),
FOREIGN KEY(USERNAME) REFERENCES CLIENTE
	ON DELETE CASCADE  ON UPDATE CASCADE
);


CREATE TABLE PRODOTTO (
CODICE_PRODOTTO CHAR(10) PRIMARY KEY,
QUANTITA_RESIDUA INTEGER NOT NULL,
DESCRIZIONE VARCHAR(200) NOT NULL,
NOME VARCHAR(100) NOT NULL,
MARCA VARCHAR(100),
CATEGORIA VARCHAR(50),
PREZZO REAL
		CHECK (PREZZO>0) 
);


CREATE TABLE DETTAGLIO (
USERNAME VARCHAR(100),
DATA DATE,
ORA TIME(0),
CODICE_PRODOTTO CHAR(10),
IMPORTO REAL NOT NULL
		CHECK (IMPORTO >0),
QUANTITA INT NOT NULL
CHECK (QUANTITA>0),
PRIMARY KEY(USERNAME, DATA, ORA, CODICE_PRODOTTO),
FOREIGN KEY(USERNAME, DATA, ORA) REFERENCES ORDINE
ON DELETE CASCADE  ON UPDATE CASCADE,
FOREIGN KEY(CODICE_PRODOTTO) REFERENCES PRODOTTO
		ON DELETE CASCADE  ON UPDATE CASCADE
);


CREATE TABLE RECENSIONE (
USERNAME VARCHAR(100),
CODICE_PRODOTTO CHAR(10),
STELLE SMALLINT NOT NULL
CHECK (STELLE BETWEEN 1 AND 5),
TITOLO VARCHAR(20),
TESTO VARCHAR(500),
PRIMARY KEY (USERNAME,CODICE_PRODOTTO),
FOREIGN KEY (CODICE_PRODOTTO) REFERENCES PRODOTTO
ON DELETE NO ACTION  ON UPDATE CASCADE,
FOREIGN KEY (USERNAME) REFERENCES CLIENTE
ON DELETE CASCADE  ON UPDATE CASCADE
);


CREATE TABLE PUNTO_VENDITA (
CODICE_PV CHAR(5) PRIMARY KEY,
PIVA CHAR(11) NOT NULL UNIQUE,
INDIRIZZO VARCHAR(150) NOT NULL,
TELEFONO VARCHAR(20),
EMAIL VARCHAR(40)
);


CREATE TABLE PROMOZIONE (
CODICE_PRODOTTO CHAR(10) NOT NULL,
CODICE_PV CHAR(5) NOT NULL,
SETTIMANA INT NOT NULL,
PREZZO_SCONTATO REAL,
PRIMARY KEY(CODICE_PRODOTTO, CODICE_PV),
FOREIGN KEY (CODICE_PRODOTTO) REFERENCES PRODOTTO
ON DELETE NO ACTION  ON UPDATE CASCADE,
FOREIGN KEY(CODICE_PV) REFERENCES PUNTO_VENDITA
	ON DELETE NO ACTION  ON UPDATE CASCADE,
UNIQUE(CODICE_PRODOTTO,SETTIMANA),
UNIQUE(CODICE_PV,SETTIMANA)
);


CREATE TABLE FORNITORE (
PIVAF CHAR(11) PRIMARY KEY,
CF CHAR(16) NOT NULL UNIQUE,
EMAIL VARCHAR(40) UNIQUE,
NOME VARCHAR(100),
COGNOME VARCHAR(100),
TELEFONO VARCHAR(10)
);


CREATE TABLE FORNITURA (
PIVAF CHAR(11),
DATA DATE,
PRIMARY KEY( PIVAF, DATA),
FOREIGN KEY (PIVAF) REFERENCES FORNITORE
	ON DELETE CASCADE ON UPDATE CASCADE
);


CREATE TABLE DI (
PIVAF CHAR(11),
DATA DATE,
CODICE_PRODOTTO CHAR(10),
QUANTITA INT,
PRIMARY KEY(PIVAF, DATA, CODICE_PRODOTTO),
FOREIGN KEY (PIVAF, DATA) REFERENCES FORNITURA
ON DELETE NO ACTION  ON UPDATE CASCADE,
FOREIGN KEY (CODICE_PRODOTTO) REFERENCES PRODOTTO
ON DELETE NO ACTION  ON UPDATE CASCADE 
);


CREATE TABLE PRESENTE_IN (
CODICE_PV CHAR(5),
CODICE_PRODOTTO CHAR(10),
PRIMARY KEY (CODICE_PV, CODICE_PRODOTTO),
FOREIGN KEY (CODICE_PV) REFERENCES PUNTO_VENDITA
ON DELETE CASCADE  ON UPDATE CASCADE,
FOREIGN KEY (CODICE_PRODOTTO) REFERENCES PRODOTTO
	ON DELETE CASCADE  ON UPDATE CASCADE
);


CREATE TABLE ACQUISTA (
COD_TESSERA CHAR (10),
CODICE_PV CHAR(5),
CODICE_PRODOTTO CHAR(10),
PRIMARY KEY (COD_TESSERA, CODICE_PV, CODICE_PRODOTTO),
FOREIGN KEY (COD_TESSERA) REFERENCES SOCIO
ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY (CODICE_PV) REFERENCES PUNTO_VENDITA
ON DELETE NO ACTION  ON UPDATE CASCADE,
FOREIGN KEY (CODICE_PRODOTTO) REFERENCES PRODOTTO
ON DELETE NO ACTION  ON UPDATE CASCADE
);


CREATE TABLE CITTA (
NOME VARCHAR (100) PRIMARY KEY
);


CREATE TABLE PRESENTE (
NOME VARCHAR(100),
CODICE_PV CHAR(5),
PRIMARY KEY (NOME, CODICE_PV),
FOREIGN KEY (NOME) REFERENCES CITTA
ON DELETE NO ACTION  ON UPDATE CASCADE,
FOREIGN KEY (CODICE_PV) REFERENCES PUNTO_VENDITA
	ON DELETE NO ACTION  ON UPDATE CASCADE
);


CREATE TABLE RESPONSABILE (
MATRICOLA_RESPONSABILE CHAR(6) PRIMARY KEY,
CF CHAR(16) NOT NULL UNIQUE,
EMAIL VARCHAR(40) UNIQUE,
NOME VARCHAR(100),
COGNOME VARCHAR(100),
SOSTITUTO CHAR(6) NOT NULL,
TELEFONO VARCHAR(20)
);


CREATE TABLE DIPENDENTE (
MATRICOLA_DIPENDENTE CHAR(6) PRIMARY KEY,
QUALIFICA VARCHAR(100) NOT NULL,
CF CHAR(16) NOT NULL UNIQUE,
EMAIL VARCHAR(40) UNIQUE,
NOME VARCHAR(100),
COGNOME VARCHAR(100),
TELEFONO VARCHAR(20)
); 


CREATE TABLE LAVORA (
MATRICOLA_DIPENDENTE CHAR(6),
CODICE_PV CHAR(5),
PRIMARY KEY (MATRICOLA_DIPENDENTE, CODICE_PV),
FOREIGN KEY (MATRICOLA_DIPENDENTE) REFERENCES DIPENDENTE 
    ON DELETE CASCADE ON UPDATE CASCADE ,
FOREIGN KEY (CODICE_PV) REFERENCES PUNTO_VENDITA 
    ON DELETE CASCADE ON UPDATE CASCADE 
);

CREATE TABLE RESPONSABILE_DI (
    MATRICOLA_RESPONSABILE CHAR(6) PRIMARY KEY,
    CODICE_PV CHAR (5) NOT NULL UNIQUE,
    FOREIGN KEY (MATRICOLA_RESPONSABILE) REFERENCES RESPONSABILE
        ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (CODICE_PV) REFERENCES PUNTO_VENDITA
        ON DELETE CASCADE ON UPDATE CASCADE
);
